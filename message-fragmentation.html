<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Message fragmentation - Substrate Mix Network Specification</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="conventions-and-definitions.html"><strong aria-hidden="true">2.</strong> Conventions and definitions</a></li><li class="chapter-item expanded "><a href="sessions.html"><strong aria-hidden="true">3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="topology.html"><strong aria-hidden="true">4.</strong> Topology</a></li><li class="chapter-item expanded "><a href="blockchain-runtime-interface.html"><strong aria-hidden="true">5.</strong> Blockchain runtime interface</a></li><li class="chapter-item expanded "><a href="networking.html"><strong aria-hidden="true">6.</strong> Networking</a></li><li class="chapter-item expanded "><a href="sphinx.html"><strong aria-hidden="true">7.</strong> Sphinx</a></li><li class="chapter-item expanded "><a href="message-fragmentation.html" class="active"><strong aria-hidden="true">8.</strong> Message fragmentation</a></li><li class="chapter-item expanded "><a href="requests-and-replies.html"><strong aria-hidden="true">9.</strong> Requests and replies</a></li><li class="chapter-item expanded "><a href="cover-traffic.html"><strong aria-hidden="true">10.</strong> Cover traffic</a></li><li class="chapter-item expanded "><a href="parameters.html"><strong aria-hidden="true">11.</strong> Parameters</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Substrate Mix Network Specification</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="message-fragmentation"><a class="header" href="#message-fragmentation">Message fragmentation</a></h1>
<p>Request and reply messages are split into 2,048-byte fragments. Each fragment of a message is
wrapped in a <a href="./sphinx.html">Sphinx packet</a> and sent along a different route to the destination. The
destination node is responsible for collecting the fragments together and reassembling the message.</p>
<h2 id="fragment-structure"><a class="header" href="#fragment-structure">Fragment structure</a></h2>
<p>The 2,048 bytes in a fragment are split as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Bytes</th><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>0..15</td><td><code>message_id</code></td><td>The same for all fragments of a message</td></tr>
<tr><td>16..17</td><td><code>num_fragments_minus_1</code></td><td>Little-endian number of fragments minus one</td></tr>
<tr><td>18..19</td><td><code>fragment_index</code></td><td>Little endian index of this fragment</td></tr>
<tr><td>20..21</td><td><code>data_size</code></td><td>Little-endian number of bytes of message data in this fragment</td></tr>
<tr><td>22</td><td><code>num_surbs</code></td><td>Number of SURBs in this fragment</td></tr>
<tr><td>23..2047</td><td><code>payload</code></td><td>Message data and SURBs</td></tr>
</tbody></table>
</div>
<p><code>payload</code> has <code>data_size</code> bytes of message data at the start, and <code>num_surbs</code>
<a href="./sphinx.html#surbs">SURBs</a> tightly packed at the end. Any unused bytes in the middle should be
written as 0 by message senders, but ignored by receivers.</p>
<h2 id="reassembly"><a class="header" href="#reassembly">Reassembly</a></h2>
<p>Received fragments should be grouped by <code>message_id</code>. Once a full set of fragments for a
<code>message_id</code> has been received, the message data and SURBs from each fragment should be
concatenated, in index order, to give the original message and an array of SURBs that can be used
to reply. The fragments should then be discarded; it is important that no SURB is used more than
once.</p>
<p>The session and type (request/reply) of a message should be inferred from the last received
fragment, and the message data and SURBs <a href="./requests-and-replies.html">handled appropriately</a>. In the
case of a reply message, the corresponding request message ID should also be inferred from the last
received packet: request message IDs should be stored alongside payload encryption keys in the SURB
keystore.</p>
<p>Note that:</p>
<ul>
<li>Malicious nodes may send fragments with the same <code>message_id</code> but differing
<code>num_fragments_minus_1</code>. Simply discarding all fragments with a different <code>num_fragments_minus_1</code>
to the first-received fragment is acceptable.</li>
<li>Nodes should enforce a limit on the number of fragments per message (see the <a href="./parameters.html">parameters
chapter</a>), by simply discarding fragments with a too-large
<code>num_fragments_minus_1</code>.</li>
<li>Multiple fragments with the same <code>message_id</code> and <code>fragment_index</code> may be received. It is
recommended that only one be kept.</li>
<li>Invalid fragments, with <code>fragment_index &gt; num_fragments_minus_1</code> or <code>(data_size + (num_surbs * 222)) &gt; 2025</code>, should be discarded.</li>
</ul>
<p>It is expected that nodes will only keep a limited number of fragments, for the most recently seen
<code>message_id</code>s.</p>
<h2 id="construction"><a class="header" href="#construction">Construction</a></h2>
<p>Message IDs should be randomly generated. When retransmitting a message, the message ID should be
reused. If a new destination is chosen for retransmission however, or if the retransmission is in a
different session, a new message ID should be generated.</p>
<p>There are essentially no rules on how message data and SURBs may be split amongst fragments; the
only constraints are:</p>
<ul>
<li>The message data and SURBs assigned to each fragment must fit.</li>
<li>The fragments-per-message limit must not be exceeded.</li>
</ul>
<p>It <em>is</em> important however that the same split is used if a message is retransmitted with the same
<code>message_id</code>.</p>
<p>When retransmitting a fragment, exactly the same message data should be sent, but new SURBs must be
generated: no SURB should ever be sent twice. When generating SURBs for a request, the message ID
should be stored in the SURB keystore alongside the payload encryption keys.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="sphinx.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="requests-and-replies.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="sphinx.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="requests-and-replies.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
