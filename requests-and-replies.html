<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Requests and replies - Substrate Mix Network Specification</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="conventions-and-definitions.html"><strong aria-hidden="true">2.</strong> Conventions and definitions</a></li><li class="chapter-item expanded "><a href="sessions.html"><strong aria-hidden="true">3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="topology.html"><strong aria-hidden="true">4.</strong> Topology</a></li><li class="chapter-item expanded "><a href="blockchain-runtime-interface.html"><strong aria-hidden="true">5.</strong> Blockchain runtime interface</a></li><li class="chapter-item expanded "><a href="networking.html"><strong aria-hidden="true">6.</strong> Networking</a></li><li class="chapter-item expanded "><a href="sphinx.html"><strong aria-hidden="true">7.</strong> Sphinx</a></li><li class="chapter-item expanded "><a href="message-fragmentation.html"><strong aria-hidden="true">8.</strong> Message fragmentation</a></li><li class="chapter-item expanded "><a href="requests-and-replies.html" class="active"><strong aria-hidden="true">9.</strong> Requests and replies</a></li><li class="chapter-item expanded "><a href="cover-traffic.html"><strong aria-hidden="true">10.</strong> Cover traffic</a></li><li class="chapter-item expanded "><a href="parameters.html"><strong aria-hidden="true">11.</strong> Parameters</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Substrate Mix Network Specification</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="requests-and-replies"><a class="header" href="#requests-and-replies">Requests and replies</a></h1>
<p>Request and reply messages are SCALE encoded. Requests have the following type:</p>
<pre><code>enum Request {
    #[codec(index = 1)]
    SubmitExtrinsic(Extrinsic),
}
</code></pre>
<p>Where <code>Extrinsic</code> is the extrinsic type of the blockchain.</p>
<p>Replies have types of the form <code>Result&lt;T, RemoteErr&gt;</code>, where <code>T</code> depends on the request, and
<code>RemoteErr</code> is defined as follows:</p>
<pre><code>enum RemoteErr {
    Other(String),
    Decode(String),
}
</code></pre>
<p><code>Decode</code> means the node failed to decode the request. <code>Other</code> means the node encountered some other
error. In both cases the <code>String</code> is a description of the error, suitable for presenting to the
user.</p>
<p>Note that nodes may simply ignore malformed requests, instead of responding with <code>Err(Decode)</code>.</p>
<h2 id="submitextrinsic"><a class="header" href="#submitextrinsic"><code>SubmitExtrinsic</code></a></h2>
<p>A <code>SubmitExtrinsic</code> request can be sent to anonymously submit an extrinsic to the blockchain. The
reply type is <code>Result&lt;(), RemoteErr&gt;</code>. <code>Ok(())</code> means the receiving node successfully imported the
extrinsic into its transaction pool. It does <em>not</em> mean that the extrinsic was included in the
blockchain.</p>
<p>After receiving a <code>SubmitExtrinsic</code> request, a node should wait before attempting to import the
extrinsic. The delay should be determined from the request message ID as follows:</p>
<pre><code>seed = blake2b(&quot;submit-extrn-dly&quot;, 0, message_id)[..16]
delay = exp_random(seed) * mean_delay
</code></pre>
<p>Where <code>mean_delay</code> is the mean extrinsic delay; see the <a href="./parameters.html">parameters chapter</a>.</p>
<h2 id="packet-queues"><a class="header" href="#packet-queues">Packet queues</a></h2>
<p>Nodes should maintain a bounded request/reply packet queue for each session. Packets from a
session's queue should be dispatched in place of <a href="./cover-traffic.html">drop cover packets</a> for the
session (provided the <a href="./sessions.html#phases">current phase</a> permits request/reply packets to be
sent). The queue bound should be the same for all mixnodes in a session; see the <a href="./parameters.html">parameters
chapter</a>.</p>
<p>Reply packets should simply be dropped if they cannot be pushed onto the request/reply queue. It is
recommended however that nodes use additional queues and/or back-pressure to avoid dropping request
packets.</p>
<h2 id="request-sending"><a class="header" href="#request-sending">Request sending</a></h2>
<p>The session for a request should be chosen according to the table in the <a href="./sessions.html#phases">sessions
chapter</a>. The destination node should be uniformly randomly picked from the
mixnodes for the session, excluding the source node and, if there is exactly one, its connected
gateway mixnode. The same session and destination should be used for retransmission, unless:</p>
<ul>
<li>The phase changes such that request packets may no longer be sent in the chosen session.</li>
<li>The destination fails to reply too many times.</li>
</ul>
<p>In these cases, a new session and destination should be selected.</p>
<p>The request message should be <a href="./message-fragmentation.html#construction">split into fragments</a>,
which should then be <a href="./sphinx.html#packet-construction">wrapped in Sphinx packets</a> and pushed onto
the session's request/reply queue. The route for each packet should be generated independently as
described in the <a href="./topology.html#route-generation">topology chapter</a>.</p>
<p>Multiple copies of each fragment may be sent to improve the chance of success. Each copy of a
fragment should contain different SURBs, and should be sent along a different route to the
destination.</p>
<h3 id="retransmission"><a class="header" href="#retransmission">Retransmission</a></h3>
<p>The round-trip time for a request can be conservatively estimated as follows:</p>
<pre><code>(s, n, m, r) = if request_period &gt; reply_period {
    (request_period, request_len, reply_len, reply_period / request_period)
} else {
    (reply_period, reply_len, request_len, request_period / reply_period)
}
queue_delay = s * (4.92582 + (3.87809 * sqrt(n + (r * r * r * m))) + n + (r * m))

net_delay = per_hop_net_delay * num_hops

rtt = forwarding_delay + queue_delay + net_delay + handling_delay
</code></pre>
<p>Where:</p>
<ul>
<li><code>request_period</code> and <code>reply_period</code> are the average periods between drop cover packet dispatches
for the session from the source node and the destination node respectively. Note that:
<ul>
<li>All mixnodes in a session should dispatch drop cover packets at the same (average) rate; see
the <a href="./parameters.html">parameters chapter</a>.</li>
<li>From the perspective of the nodes, the session phase may change at any time. As such, it should
be assumed, for a conservative estimate, regardless of the current phase, that traffic will be
sent at half rate in all sessions.</li>
</ul>
</li>
<li><code>request_len</code> is the number of request/reply packets queued ahead of the last request packet,
plus one.</li>
<li><code>reply_len</code> is the maximum length of the destination node's request/reply queue. Note that all
mixnodes in a session should have the same queue bound; see the <a href="./parameters.html">parameters
chapter</a>.</li>
<li>The <code>queue_delay</code> expression is an approximation of the 99.995th percentile of the sum of two
independent gamma-distributed random variables with different scales (<code>s</code>, <code>s * r</code>) and shapes
(<code>n</code>, <code>m</code>).</li>
<li><code>per_hop_net_delay</code> is a conservative estimate of the network (and processing) delay per hop.</li>
<li><code>num_hops</code> is the maximum number of hops for any of the fragments to reach the destination, plus
the maximum number of hops for any of the SURBs to come back. The number of hops in a route is
the number of nodes (including both source and destination) minus one.</li>
<li><code>forwarding_delay</code> is the maximum total <a href="./sphinx.html#forward-actions">forwarding delay</a> for any
request fragment, plus the maximum total forwarding delay for any SURB.</li>
<li><code>handling_delay</code> is a conservative estimate of the time taken to handle the request at the
destination and post the reply. In the case of a <a href="#submitextrinsic"><code>SubmitExtrinsic</code></a> request
for example, this should include the artifical extrinsic delay.</li>
</ul>
<p>If a complete reply message is not received within this time, the request message may be
retransmitted. When retransmitting, different packet routes should be used, and new SURBs should be
generated.</p>
<h2 id="request-handling"><a class="header" href="#request-handling">Request handling</a></h2>
<p>Sending a reply message is similar to sending a request message. The message is <a href="./message-fragmentation.html#construction">split into
fragments</a>, which are then wrapped in Sphinx packets
(<a href="./sphinx.html#surb-use">using the SURBs</a> attached to the request message) and pushed onto the
session's request/reply queue. Multiple copies of each fragment may be sent, provided enough SURBs
were attached to the request message, and there is enough space in the request/reply queue.</p>
<p>To avoid handling the same request multiple times, reply messages should be cached by request
message ID. When sending a cached reply, the original reply message ID should be reused, but the
Sphinx packets should be constructed from different SURBs (eg the ones attached to the triggering
request message).</p>
<p>If two request messages with the same ID are received in short succession (as determined by the
reply cooldown <a href="./parameters.html">parameter</a>), the second message should be assumed to be a copy
sent at the same time as the first, rather than a retransmission, and should be ignored.</p>
<h2 id="reply-handling"><a class="header" href="#reply-handling">Reply handling</a></h2>
<p>The request message ID corresponding to a received reply message should be inferred from the last
received packet; the SURB keystore stores request message IDs alongside payload encryption keys.
The request to which the message is a reply should be determined from this ID. If the ID is no
longer recognised, the reply message should simply be dropped.</p>
<p>Any SURBs attached to a reply message should be ignored.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="message-fragmentation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="cover-traffic.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="message-fragmentation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="cover-traffic.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
